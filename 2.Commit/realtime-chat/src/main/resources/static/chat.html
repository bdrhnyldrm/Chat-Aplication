<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GerÃ§ek ZamanlÄ± Sohbet</title>
</head>
<body>
<h2>GerÃ§ek ZamanlÄ± MesajlaÅŸma</h2>

<label>ğŸ‘¤ KullanÄ±cÄ± AdÄ±: <input type="text" id="username" /></label> <!-- KullanÄ±cÄ± adÄ±nÄ± girmek iÃ§in giriÅŸ alanÄ± -->
<br/>
<label>ğŸ“© AlÄ±cÄ±: <input type="text" id="receiver" /></label> <!-- MesajÄ±n gÃ¶nderileceÄŸi alÄ±cÄ±yÄ± girmek iÃ§in giriÅŸ alanÄ± -->
<br/>
<label>âœï¸ Mesaj: <input type="text" id="message" /></label> <!-- GÃ¶nderilecek mesajÄ± girmek iÃ§in giriÅŸ alanÄ± -->
<br/>
<button onclick="connect()">ğŸ”Œ BaÄŸlan</button> <!-- WebSocket baÄŸlantÄ±sÄ±nÄ± baÅŸlatan buton -->
<button onclick="sendMessage()">ğŸ“¨ GÃ¶nder</button> <!-- Mesaj gÃ¶ndermek iÃ§in kullanÄ±lan buton -->

<hr>
<div id="chat-box"></div> <!-- Gelen mesajlarÄ±n gÃ¶rÃ¼ntÃ¼leneceÄŸi alan -->

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script> <!-- SockJS kÃ¼tÃ¼phanesi -->
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script> <!-- STOMP protokolÃ¼ iÃ§in kÃ¼tÃ¼phane -->

<script>
    let stompClient = null; // STOMP istemcisi
    let username = ""; // KullanÄ±cÄ± adÄ±

    function connect() {
        username = document.getElementById("username").value; // KullanÄ±cÄ± adÄ±nÄ± alÄ±r

        const socket = new SockJS("/chat"); // SockJS baÄŸlantÄ±sÄ±nÄ± baÅŸlatÄ±r
        stompClient = Stomp.over(socket); // STOMP istemcisini oluÅŸturur

        stompClient.connect({}, function () {
            alert(username + " olarak baÄŸlandÄ±n!"); // BaÄŸlantÄ± baÅŸarÄ±lÄ± olduÄŸunda kullanÄ±cÄ±ya bilgi verir

            fetch(`/messages/${username}/${document.getElementById("receiver").value}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(msg => {
                        const display = msg.sender + ": " + msg.content;
                        document.getElementById("chat-box").innerHTML += `<p>${display}</p>`;
                    });
                });

            stompClient.subscribe("/topic/messages/" + username, function (message) {
                const msg = JSON.parse(message.body);
                const display = `${msg.sender}: ${msg.content} (${msg.status})`;
                document.getElementById("chat-box").innerHTML += `<p>${display}</p>`;

                // EÄŸer mesaj zaten READ ise tekrar okundu olarak iÅŸaretleme
                if (msg.status !== "READ") {
                    fetch(`/messages/${msg.id}/read`, {
                        method: "PUT"
                    });
                }
            });
        });
    }

    function sendMessage() {
        const content = document.getElementById("message").value; // Mesaj iÃ§eriÄŸini alÄ±r
        const receiver = document.getElementById("receiver").value; // AlÄ±cÄ± bilgisini alÄ±r

        stompClient.send("/app/chat", {}, JSON.stringify({
            sender: username, // MesajÄ± gÃ¶nderen kullanÄ±cÄ±
            receiver: receiver, // MesajÄ±n alÄ±cÄ±sÄ±
            content: content // MesajÄ±n iÃ§eriÄŸi
        })); // MesajÄ± sunucuya gÃ¶nderir
    }
</script>
</body>
</html>
