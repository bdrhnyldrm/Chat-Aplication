<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Sohbet</title>
</head>
<body>

<h2>ğŸ’¬ GerÃ§ek ZamanlÄ± Sohbet</h2>

<p id="greeting"></p>

<div style="display: flex; gap: 50px;">
  <div>
    <h4>ğŸ‘¥ KiÅŸi Listesi</h4>
    <ul id="user-list"></ul>
  </div>
  <div>
    <h4>ğŸ’¬ Sohbet GeÃ§miÅŸi</h4>
    <ul id="conversation-list"></ul>
  </div>
</div>
<hr>

<label>AlÄ±cÄ±: <input type="text" id="receiver" /></label><br/>
<label>Mesaj: <input type="text" id="message" /></label><br/>
<button onclick="sendMessage()">GÃ¶nder</button>

<hr>
<div id="chat-box"></div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;
    let currentUser = "";

    // URL'den kullanÄ±cÄ± adÄ±nÄ± al
    const urlParams = new URLSearchParams(window.location.search);
    currentUser = urlParams.get("user");

    if (!currentUser) {
      alert("KullanÄ±cÄ± adÄ± bulunamadÄ±. LÃ¼tfen giriÅŸ yapÄ±n.");
      window.location.href = "/login.html";
    }

    document.getElementById("greeting").innerText = `${currentUser} olarak giriÅŸ yaptÄ±nÄ±z.`;

    function connectWebSocket() {
      const socket = new SockJS("/chat");
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function () {
        // GiriÅŸte Ã¶nceki okunmamÄ±ÅŸ mesajlarÄ± da okundu olarak iÅŸaretle
        fetch(`/messages/mark-all-read/${currentUser}`, { method: "PUT" });

        stompClient.subscribe("/topic/messages/" + currentUser, function (message) {
          const msg = JSON.parse(message.body);
          const display = `${msg.sender}: ${msg.content} (${msg.status})`;
          const chatBox = document.getElementById("chat-box");

          // EÄŸer aynÄ± mesaj daha Ã¶nce eklendiyse tekrar gÃ¶sterme
          if (!document.getElementById("msg-" + msg.id)) {
            const p = document.createElement("p");
            p.id = "msg-" + msg.id;
            p.innerText = display;
            chatBox.appendChild(p);
          } else {
            // Mevcutsa sadece status'Ã¼ gÃ¼ncelle
            const existing = document.getElementById("msg-" + msg.id);
            existing.innerText = display;
          }

          // EÄŸer bu mesajÄ±n alÄ±cÄ±sÄ± bu kullanÄ±cÄ±ysa ve henÃ¼z READ deÄŸilse â†’ READ yap
          if (msg.receiver === currentUser && msg.status !== "READ") {
            fetch(`/messages/${msg.id}/read`, { method: "PUT" });
          }
        });

        // KullanÄ±cÄ± listelerini yÃ¼kle
        loadUserLists();
      });
    }

    function loadUserLists() {
      // KiÅŸi listesi
      fetch(`/users/all/${currentUser}`)
        .then(res => res.json())
        .then(data => {
          const userList = document.getElementById("user-list");
          userList.innerHTML = "";
          data.forEach(user => {
            const li = document.createElement("li");
            li.innerText = user;
            li.style.cursor = "pointer";
            li.onclick = () => {
              document.getElementById("receiver").value = user;
              loadChatHistory(user);
            };
            userList.appendChild(li);
          });
        });

      // Sohbet geÃ§miÅŸi
      fetch(`/users/conversations/${currentUser}`)
        .then(res => res.json())
        .then(data => {
          const convList = document.getElementById("conversation-list");
          convList.innerHTML = "";
          data.forEach(user => {
            const li = document.createElement("li");
            li.innerText = user;
            li.style.cursor = "pointer";
            li.onclick = () => {
              document.getElementById("receiver").value = user;
              loadChatHistory(user);
            };
            convList.appendChild(li);
          });
        });
    }

    function loadChatHistory(receiver) {
        // Ã–nce okunmamÄ±ÅŸ mesajlarÄ± READ olarak iÅŸaretle
        fetch(`/messages/mark-read/${currentUser}/${receiver}`, { method: "PUT" });

        document.getElementById("chat-box").innerHTML = "";

        fetch(`/messages/${currentUser}/${receiver}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(msg => {
                    const display = `${msg.sender}: ${msg.content} (${msg.status})`;
                    const chatBox = document.getElementById("chat-box");

                    if (!document.getElementById("msg-" + msg.id)) {
                        const p = document.createElement("p");
                        p.id = "msg-" + msg.id;
                        p.innerText = display;
                        chatBox.appendChild(p);
                    } else {
                        document.getElementById("msg-" + msg.id).innerText = display;
                    }
                });
            });
    }


    function sendMessage() {
      if (!currentUser) {
        alert("GiriÅŸ yapmadan mesaj gÃ¶nderemezsiniz.");
        return;
      }

      const receiver = document.getElementById("receiver").value;
      const content = document.getElementById("message").value;

      if (!receiver || !content) {
        alert("AlÄ±cÄ± ve mesaj boÅŸ olamaz.");
        return;
      }

      stompClient.send("/app/chat", {}, JSON.stringify({
        sender: currentUser,
        receiver: receiver,
        content: content
      }));

      // Mesaj kutusunu temizle
      document.getElementById("message").value = "";
    }

    connectWebSocket(); // Sayfa yÃ¼klenince otomatik baÄŸlan
</script>

</body>
</html>
